<!doctype html>
<html lang="sv">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Slå ihop journey_logs.json (med dubblettskydd)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:1rem;line-height:1.45;background:#f8fafc;color:#0f172a}
  h1{font-size:1.25rem;margin:0 0 .4rem}
  p{margin:.15rem 0 .6rem}
  .bar{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin:.6rem 0 .8rem}
  button{padding:.5rem .9rem;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer;transition:all .15s ease}
  button.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  button:disabled{opacity:.5;cursor:not-allowed}
  button:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,0.07)}
  .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:1rem;margin:.6rem 0}
  table{border-collapse:collapse;width:100%;background:#fff}
  th,td{border:1px solid #e2e8f0;padding:.45rem .6rem;text-align:left}
  th{background:#f1f5f9}
  .mut{color:#64748b}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .55rem;background:#e2e8f0;border-radius:999px;font-size:.9rem;margin:.15rem .3rem .15rem 0}
  .pill small{color:#475569}
</style>
<h1>Slå ihop journey_logs.json</h1>
<p class="mut">Lägg till hur många JSON-filer som helst (från appens export), slå ihop med dubblettskydd och ladda ner en enda fil.</p>
<div class="bar">
  <input id="filePicker" type="file" accept="application/json" multiple style="display:none">
  <button id="btnAdd">Lägg till filer</button>
  <button id="btnClear">Töm listan</button>
  <button id="btnMerge" class="primary">Slå ihop</button>
  <button id="btnDownloadCompact" disabled>Hämta merged (kompakt)</button>
  <button id="btnDownloadPretty"  disabled>Hämta merged (läsbar)</button>
</div>
<div id="chips" aria-live="polite"></div>

<div id="summary" class="card" style="display:none"></div>
<div class="card">
  <table id="tbl" style="display:none">
    <thead><tr><th>Filnamn</th><th>Antal poster</th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><th>Totalt inkommande</th><th id="totIn">0</th></tr>
           <tr><th>Efter dubblettskydd</th><th id="totOut">0</th></tr>
           <tr><th>Borttagna dubbletter</th><th id="totDup">0</th></tr></tfoot>
  </table>
</div>

<script>
const picker = document.getElementById('filePicker');
const btnAdd = document.getElementById('btnAdd');
const btnClear = document.getElementById('btnClear');
const btnMerge = document.getElementById('btnMerge');
const bC = document.getElementById('btnDownloadCompact');
const bP = document.getElementById('btnDownloadPretty');
const chips = document.getElementById('chips');
const tbl = document.getElementById('tbl');
const tbody = tbl.querySelector('tbody');
const totInEl = document.getElementById('totIn');
const totOutEl= document.getElementById('totOut');
const totDupEl= document.getElementById('totDup');
const summary = document.getElementById('summary');

let merged = [];
let selected = []; // {file, key, count}

function norm(x){ return x==null ? "" : String(x); }
function stopSignature(st){
  return [
    norm(st.name),
    norm(st.actualArrival),
    norm(st.actualDeparture),
    st.excludeInboundRun ? "X" : "",
    (st.skipNoStop || st.skippedStop) ? "S" : ""
  ].join("|");
}
async function readJSON(f){
  const txt = await f.text();
  try{
    const data = JSON.parse(txt);
    if(Array.isArray(data)) return data;
    if(data && typeof data === "object") return [data];
    return [];
  }catch(e){
    console.error("Ogiltig JSON i", f.name, e);
    return [];
  }
}
function entryKey(e){
  if(e && e.measurementId) return "mid::"+e.measurementId;
  const t = norm(e.trainNumber), r = norm(e.route), d = norm(e.date);
  const stops = Array.isArray(e.stops) ? e.stops : [];
  const n = stops.length;
  const first = n>0 ? stopSignature(stops[0]) : "";
  const last  = n>0 ? stopSignature(stops[n-1]) : "";
  const raw = `${t}||${r}||${d}||${n}||${first}||${last}`;
  const enc = new TextEncoder().encode(raw);
  return crypto.subtle.digest("SHA-1", enc).then(buf=>{
    const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    return "sig::"+hex;
  });
}

function renderQueue(){
  chips.innerHTML = "";
  if(!selected.length){
    tbl.style.display = "none";
    summary.style.display = "none";
    totInEl.textContent = "0";
    totOutEl.textContent = "0";
    totDupEl.textContent = "0";
    tbody.innerHTML = "";
    bC.disabled = true; bP.disabled = true;
    return;
  }
  selected.forEach(({file,count})=>{
    const pill = document.createElement('span');
    pill.className = "pill";
    pill.textContent = file.name;
    const sm = document.createElement('small');
    sm.textContent = count==null ? "ej läst ännu" : `${count} poster`;
    pill.appendChild(sm);
    chips.appendChild(pill);
  });
}

function addFiles(fileList){
  let added = 0;
  for(const f of fileList){
    const key = `${f.name}::${f.size}::${f.lastModified}`;
    if(selected.some(x=>x.key===key)) continue;
    selected.push({file:f,key,count:null});
    added++;
  }
  if(!added && fileList.length){
    summary.style.display = "";
    summary.textContent = "Alla valda filer fanns redan i listan.";
  }
  renderQueue();
}

btnAdd.addEventListener('click', ()=> picker.click());
picker.addEventListener('change', ()=>{
  addFiles([...picker.files]);
  picker.value = "";
});

btnClear.addEventListener('click', ()=>{
  selected = [];
  merged = [];
  summary.style.display = "none";
  renderQueue();
});

btnMerge.addEventListener('click', async ()=>{
  if(!selected.length){ alert("Lägg till minst en JSON-fil."); return; }
  const files = selected.map(s=>s.file);

  const lists = await Promise.all(files.map(readJSON));
  const perFileCounts = lists.map(a=>a.length);
  const incoming = lists.flat();

  const seen = new Set();
  const out = [];
  const keysPromises = incoming.map(e=>entryKey(e));
  const keys = await Promise.all(keysPromises);
  for(let i=0;i<incoming.length;i++){
    const k = keys[i];
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(incoming[i]);
  }
  merged = out;

  selected = selected.map((s,idx)=>({...s,count:perFileCounts[idx]||0}));
  renderQueue();

  tbody.innerHTML = "";
  files.forEach((f,idx)=>{
    const tr = document.createElement('tr');
    const count = perFileCounts[idx] ?? 0;
    tr.innerHTML = `<td>${f.name}</td><td>${count}</td>`;
    tbody.appendChild(tr);
  });
  tbl.style.display = "";
  const totIn = perFileCounts.reduce((a,b)=>a+b,0);
  totInEl.textContent  = totIn;
  totOutEl.textContent = out.length;
  totDupEl.textContent = totIn - out.length;

  summary.style.display = "";
  summary.textContent = "Klar: sammanslagning med dubblettskydd genomförd.";

  bC.disabled = false; bP.disabled = false;
});

function downloadBlob(obj, filename, pretty=false){
  const txt = pretty ? JSON.stringify(obj, null, 2) : JSON.stringify(obj);
  const blob = new Blob([txt], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1200);
}

bC.addEventListener('click', ()=> downloadBlob(merged, "journey_logs_merged.json", false));
bP.addEventListener('click', ()=> downloadBlob(merged, "journey_logs_merged_pretty.json", true));
</script>
