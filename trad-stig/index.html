<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tr√§d och stigar</title>
  <style>
    :root {
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #eef5ff, #f8fbff);
      color: #0f1729;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
    }
    .card {
      width: min(540px, 92vw);
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 18px 55px rgba(15, 23, 41, 0.14);
      padding: 20px 22px 18px;
      display: grid;
      gap: 14px;
    }
    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: -0.02em;
    }
    p {
      margin: 0;
      color: #4b5565;
    }
    .buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    button {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 8px 24px rgba(15, 23, 41, 0.16);
    }
    button:active { transform: translateY(1px); }
    .tree { background: linear-gradient(120deg, #1b7f3b, #2fbf71); }
    .path { background: linear-gradient(120deg, #c96a0a, #f29d38); }
    .secondary {
      background: #f2f4f7;
      color: #0f1729;
      box-shadow: none;
    }
    .status {
      font-size: 14px;
      color: #6b7280;
      min-height: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td { padding: 6px 4px; text-align: left; }
    th { color: #6b7280; font-weight: 600; }
    tr:nth-child(every) { background: #f9fafb; }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, "Cascadia Code", monospace; }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
  </style>
</head>
<body>
  <main class="card">
    <header>
      <h1>Rapportera risk</h1>
      <p>Tryck bara p√• knappen. Position och tid sparas lokalt.</p>
    </header>

    <div class="buttons">
      <button class="tree" data-type="Tr√§d lutar">üå≤ Tr√§d lutar</button>
      <button class="path" data-type="Stig √∂ver sp√•r">üö∂‚Äç‚ôÇÔ∏è Stig √∂ver sp√•r</button>
    </div>

    <div class="status" id="status"></div>
    <div class="row">
      <span id="gps-status" class="mono" style="color:#6b7280;">GPS startas...</span>
      <div class="actions">
        <button class="secondary" id="start-gps">Starta GPS</button>
      </div>
    </div>

    <div class="row">
      <strong>Sparade noteringar</strong>
      <div class="actions">
        <button class="secondary" id="save-file">Spara till fil</button>
        <button class="secondary" id="copy">Kopiera CSV</button>
        <button class="secondary" id="clear">Rensa</button>
      </div>
    </div>

    <div style="overflow-x:auto;">
      <table id="log">
        <thead>
          <tr>
            <th>Typ</th>
            <th>Lat</th>
            <th>Lon</th>
            <th>Tid</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    const statusEl = document.getElementById("status");
    const gpsStatusEl = document.getElementById("gps-status");
    const logBody = document.querySelector("#log tbody");
    const storageKey = "trees-paths-v1";
    let watchId = null;
    let latestPos = null;

    function loadRows() {
      const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
      logBody.innerHTML = "";
      if (!data.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 4;
        cell.textContent = "Inget sparat √§nnu.";
        cell.style.color = "#6b7280";
        row.appendChild(cell);
        logBody.appendChild(row);
        return;
      }
      for (const entry of data) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.type}</td>
          <td class="mono">${entry.lat.toFixed(6)}</td>
          <td class="mono">${entry.lon.toFixed(6)}</td>
          <td class="mono">${entry.time}</td>
        `;
        logBody.appendChild(row);
      }
    }

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.style.color = isError ? "#b42318" : "#6b7280";
    }

    function renderGpsStatus(pos) {
      if (!pos) {
        gpsStatusEl.textContent = "Ingen fix √§n.";
        gpsStatusEl.style.color = "#b42318";
        return;
      }
      const t = new Date(pos.timestamp).toLocaleTimeString("sv-SE");
      const acc = Math.round(pos.coords.accuracy);
      gpsStatusEl.textContent = `Fix ${t} (¬±${acc} m)`;
      gpsStatusEl.style.color = "#0f1729";
    }

    function startGpsWatch() {
      if (!navigator.geolocation) {
        setStatus("Geolocation st√∂d saknas i webbl√§saren.", true);
        renderGpsStatus(null);
        return;
      }
      if (watchId) navigator.geolocation.clearWatch(watchId);
      setStatus("Startar GPS...");
      renderGpsStatus(null);
      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          latestPos = pos;
          renderGpsStatus(pos);
          setStatus("GPS aktiv.");
        },
        (err) => {
          latestPos = null;
          renderGpsStatus(null);
          setStatus("Kunde inte starta GPS: " + err.message, true);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    function normalizeEntry(entry, idx){
      if(!entry || typeof entry!=="object") return null;
      const t = entry.type || `okand-${idx}`;
      const lat = Number(entry.lat);
      const lon = Number(entry.lon);
      const time = entry.time || "";
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return { type:t, lat, lon, time };
    }

    function dedupeEntries(list){
      const seen=new Set();
      const out=[];
      (list||[]).forEach((item, idx)=>{
        const n=normalizeEntry(item, idx);
        if(!n) return;
        const key=`${n.type}|${n.lat}|${n.lon}|${n.time}`;
        if(!seen.has(key)){
          seen.add(key);
          out.push(n);
        }
      });
      return out;
    }

    async function saveFileMerge(){
      if(!("showOpenFilePicker" in window)){
        setStatus("Fil-API saknas i webbl√§saren.", true);
        return;
      }
      const localData=dedupeEntries(JSON.parse(localStorage.getItem(storageKey) || "[]"));
      try{
        let handle=null;
        try{
          const pick=await window.showOpenFilePicker({
            types:[{description:"JSON-loggar",accept:{"application/json":[".json"]}}],
            excludeAcceptAllOption:false,
            multiple:false
          });
          if(pick && pick[0]) handle=pick[0];
        }catch(e){
          if(e && e.name==="AbortError"){
            setStatus("Sparande avbr√∂ts.", true);
            return;
          }
          throw e;
        }
        if(!handle){
          setStatus("Ingen fil vald.", true);
          return;
        }
        let incoming=[];
        try{
          const file=await handle.getFile();
          const text=await file.text();
          const parsed=(()=>{
            try{ return JSON.parse(text||"[]"); }
            catch(_){ return null; }
          })();
          if(parsed===null){
            setStatus("Kunde inte l√§sa filen.", true);
            return;
          }
          incoming=Array.isArray(parsed)?parsed:(parsed?[parsed]:[]);
        }catch(_){
          incoming=[];
        }
        const merged=dedupeEntries(localData.concat(incoming));
        if(!merged.length){
          setStatus("Inga loggar att spara.", true);
          return;
        }
        const writable=await handle.createWritable();
        await writable.write(JSON.stringify(merged,null,2));
        await writable.close();
        localStorage.setItem(storageKey, JSON.stringify(merged));
        loadRows();
        setStatus(`Sparat & synkat: ${merged.length} poster.`);
      }catch(err){
        const msg=err && (err.message||err.name)?`${err.name||""} ${err.message||""}`.trim():"Kunde inte spara.";
        setStatus(msg, true);
      }
    }

    async function capture(type) {
      if (!latestPos) {
        setStatus("GPS inte klar √§nnu. V√§nta eller starta om GPS.", true);
        return;
      }
      const { latitude, longitude } = latestPos.coords;
      const now = new Date().toLocaleString("sv-SE");
      const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
      data.unshift({ type, lat: latitude, lon: longitude, time: now });
      localStorage.setItem(storageKey, JSON.stringify(data));
      setStatus(`Sparade ${type.toLowerCase()}.`);
      loadRows();
    }

    document.querySelectorAll("button[data-type]").forEach((btn) => {
      btn.addEventListener("click", () => capture(btn.dataset.type));
    });

    document.getElementById("start-gps").addEventListener("click", () => {
      startGpsWatch();
    });

    document.getElementById("save-file").addEventListener("click", saveFileMerge);

    document.getElementById("clear").addEventListener("click", () => {
      if (confirm("Rensa alla sparade punkter?")) {
        localStorage.removeItem(storageKey);
        loadRows();
        setStatus("Listan √§r rensad.");
      }
    });

    document.getElementById("copy").addEventListener("click", async () => {
      const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
      if (!data.length) {
        setStatus("Inget att kopiera.");
        return;
      }
      const header = "typ,lat,lon,tid";
      const rows = data.map(d => [d.type, d.lat, d.lon, d.time].join(","));
      const csv = [header, ...rows].join("\\n");
      try {
        await navigator.clipboard.writeText(csv);
        setStatus("CSV kopierat.");
      } catch {
        setStatus("Kunde inte kopiera.", true);
      }
    });

    loadRows();
    startGpsWatch();
    setStatus("GPS startas... tryck p√• r√§tt knapp n√§r klar.");
  </script>
</body>
</html>
